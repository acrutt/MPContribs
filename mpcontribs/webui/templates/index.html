{% extends "layout.html" %}
{% block body %}

<link rel="stylesheet" type="text/css" media="all" href="{{ url_for('static', filename='css/json.human.css') }}">
<link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='css/backgrid.min.css') }}"/>

<nav class="navbar navbar-default navbar-lower" role="navigation">
  <div class="container">
    <form class="navbar-form navbar-left">
      <div class="form-group" style="position:relative; left:20px;">
        <div>
          <div class="checkbox" style="padding:1px;">
            <label>
              <input id="toggle_trees" type="checkbox" checked>
              <script>
                $('#toggle_trees').bootstrapToggle({
                  on:"h-Data", off:"h-Data", size:"mini", width:65, height:25
                });
              </script>
            </label>
          </div>
        </div>
        <div>
          <div class="checkbox" style="padding:1px;">
            <label>
              <input id="toggle_tables" type="checkbox" checked>
              <script>
                $('#toggle_tables').bootstrapToggle({
                  on:"Tables", off:"Tables", size:"mini", width:65, height:25
                });
              </script>
            </label>
          </div>
        </div>
        <div>
          <div class="checkbox" style="padding:1px;">
            <label>
              <input id="toggle_graphs" type="checkbox" checked>
              <script>
                $('#toggle_graphs').bootstrapToggle({
                  on:"Graphs", off:"Graphs", size:"mini", width:65, height:25
                });
              </script>
            </label>
          </div>
        </div>
      </div>
      <div class="form-group" style="position:relative; left:20px; margin-left:15px;">
        <select id="gotolist" data-placeholder="Go to Contribution ..." style="width:200px;">
          <option></option>
        </select>
      </div>
      <div class="form-group" style="position:relative; left:20px; margin-left:115px;">
        <select id="axespicker" data-placeholder="Select x-y-z Axes for Overview Graph (in order!) ..." style="width:600px;" multiple>
          <option></option>
        </select>
        <button id="plot_ovdata" type="button" class="btn btn-primary btn-sm">Plot</button>
      </div>
    </form>
    <ul class="nav navbar-nav navbar-right">
      <li><a class="btn btn-lg navbar-btn" href="#top"><span class="glyphicon glyphicon-menu-up" aria-hidden="true"></span></br>top</a></li>
    </ul>
  </div>
</nav>

<style>
.affix { top: 68px; width:100%; z-index: 1000; }
.navbar-form { padding-left: 0; }
a.anchor { display: block; position: relative; top: -120px; visibility: hidden; }
.backgrid .string-cell { text-align: center; }
</style>

<script type="text/javascript" charset="utf8" src="{{ url_for('static', filename='js/require.js') }}"></script>
<script>
  require.config({
      baseUrl: "/static/js",
      paths: {
        "plotly": "plotly.min",
        "underscore": "underscore-min",
        "backbone": "backbone-min"
      }
  })
  $('#axespicker').chosen({ search_contains: true, max_selected_options: 3 });
  $('.navbar-lower').affix({ offset: {top: -5} });
  $('#gotolist').chosen({ search_contains: true });
  $(document).ready(function(){
    $('#gotolist').on('change', function() { location.href = this.value; });
  })
  window.options = {
    showArrayIndex: false,
    hyperlinks : { enable : true, keys: [], target : '_blank' },
    bool : {
      showText : true,
      text : { true : "true", false : "false" },
      showImage : false
    }
  };
  // http://stackoverflow.com/questions/1344500/efficient-way-to-insert-a-number-into-a-sorted-array-of-numbers
  // adjusted for uniqueness
  function insert(element, array) {
    var loc = locationOf(element, array);
    if (loc != null) array.splice(loc + 1, 0, element);
    return array;
  }
  function locationOf(element, array, start, end) {
    start = start || 0;
    end = end || array.length;
    var pivot = parseInt(start + (end - start) / 2, 10);
    if (array[pivot] === element) return null;
    if (end-start <= 1)
      return array[pivot] > element ? pivot - 1 : pivot;
    if (array[pivot] < element) {
      return locationOf(element, array, pivot, end);
    } else {
      return locationOf(element, array, start, pivot);
    }
  }
</script>

<div class="container">
  <div class="alert alert-warning" role="alert" style="position:relative; height:150px; overflow:hidden;">
    <div id='output' style="position:absolute; bottom:0; width:100%;"></div>
  </div>
</div>

<a class="anchor" name="top"></a>
<div id="ovdata_graph"></div>

{% for c in content: %}

{% if c is string %}
<script>$("#output").append("{{ c|safe }}");</script>

{% elif c is mapping %}
<input type=hidden name=ovdata id=inputovdata value=''>
<script>
  var list = document.getElementById('axespicker');
  var entries = {{ c.keys()|tojson|safe }};
  for (var i=0; i<entries.length; ++i) {
    var entry = document.createElement('option');
    entry.value = entries[i];
    entry.innerHTML = entries[i];
    list.appendChild(entry);
  }
  $('#axespicker').trigger('chosen:updated');
  var ovdata = document.getElementById('inputovdata');
  ovdata.value = JSON.stringify({{ c|tojson|safe }});
  $('#plot_ovdata').on('click', function() {
    var axes = [];
    var axes_select = document.getElementById('axespicker');
    for (var i=0, iLen=axes_select.options.length; i<iLen; i++) {
      var opt = axes_select.options[i];
      if (opt.selected) { axes.push(opt.value); }
    }
    var ovdata = JSON.parse(document.getElementById('inputovdata').value);
    var xAxis = ovdata[axes[2]], yAxis = ovdata[axes[1]], zAxis = ovdata[axes[0]];
    var xValues = [], yValues = [], zValues = [], text = [];
    for (var cid in xAxis) { insert(xAxis[cid][0], xValues); }
    for (var cid in yAxis) { insert(yAxis[cid][0], yValues); }
    for (var i=0, iLen=yValues.length; i<iLen; i++) { zValues[i] = []; text[i] = []; }
    for (var cid in zAxis) {
      var xVal = xAxis[cid][0], yVal = yAxis[cid][0], zVal = zAxis[cid][0];
      var xIdx = xValues.indexOf(xVal), yIdx = yValues.indexOf(yVal);
      zValues[yIdx][xIdx] = zVal;
      text[yIdx][xIdx] = zAxis[cid][1] + ' ' + cid;
    }
    var data = [{ x: xValues, y: yValues, z: zValues, text: text, type: 'heatmap' }];
    var elem = document.getElementById('ovdata_graph');
    elem.style['width'] = '580px'; elem.style['height'] = "580px";
    elem.style['margin-left'] = 'auto'; elem.style['margin-right'] = 'auto';
    Plotly.newPlot('ovdata_graph', data);
    location.href = '#top';
    $('#ovdata_graph').bind('plotly_click', function(event, data) {
      for(var i=0; i<data.points.length; i++){
        var pn = data.points[i].pointNumber;
        var tx = data.points[i].data.text;
        location.href = '#cid' + tx[pn[0]][pn[1]].split(" ")[1];
      }
    });
  });
</script>

{% elif c is sequence %}
<script>
  var list = document.getElementById('gotolist');
  var entry = document.createElement('option');
  entry.value = "#cid{{ c[2] }}";
  entry.innerHTML = "{{ c[0] }} (#{{ c[2] }})";
  list.appendChild(entry);
  $('#gotolist').trigger('chosen:updated');
</script>

<a class="anchor" name="cid{{ c[2] }}"></a><hr>
{{ c[3]|safe }}

{% endif %}
{% endfor %}

<script>
  function toggle_divs(div_names) {
    for (var i=0; i<div_names.length; i++) {
      var divs = document.getElementsByName(div_names[i]);
      for (var j=0; j<divs.length; j++) {
        if ($(divs[j]).is(":visible")) { $(divs[j]).hide(); }
        else { $(divs[j]).show(); }
      }
    }
  };
  $('#toggle_trees').change(function () { toggle_divs(["tree_row"]); });
  $('#toggle_tables').change(function () { toggle_divs(["table_row"]); });
  $('#toggle_graphs').change(function () { toggle_divs(["graph_row"]); });
</script>
{% endblock %}
