{% extends "layout.html" %}
{% block body %}
{% if "archieml" in session.options %}
<link href="{{ url_for('static', filename='css/archieml.css') }}" media="screen, projection" rel="stylesheet" type="text/css" />
<script src="{{ url_for('static', filename='js/archieml.js') }}"></script>
{% if "mpfile" in session %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/site.css') }}" type="text/css"/>
<link rel="stylesheet" href="{{ url_for('static', filename='css/codemirror.min.css') }}" type="text/css"/>
<script src="{{ url_for('static', filename='js/main-built.js') }}" type="text/javascript" charset="utf-8"></script>
<script>
$(function(){
  var thebe = new Thebe({
    tmpnb_mode: false,
    add_interrupt_button: true,
    url: 'http://localhost:8888/'
  });
});
</script>
<div class="container">
  <div class="row">
    <div id="thebe" class="col-md-7">
      {% if "thebe" not in session %}
      {% if session.options|length == 2 %}
      <pre data-executable='true'>
%load_ext autoreload
%autoreload 2
from mpcontribs.io.{{ session.options[0] }}.mpfile import MPFile
mpfile = MPFile.from_file()
# Load pre-submission processing of "{{ session.options[1] }}" project
from mpcontribs.users.{{ session.options[1] }}.pre_submission import run
run(mpfile)
mpfile.write_file()
      </pre>
      {% else %}
      <pre data-executable='true'>
%load_ext autoreload
%autoreload 2
from mpcontribs.io.{{ session.options[0] }}.mpfile import MPFile
mpfile = MPFile.from_file()
# do some pre-submission processing with MPFile ...
mpfile.write_file()
      </pre>
      {% endif %}
      {% else %}
      <pre data-executable='true'>{{ session.thebe }}</pre>
      {% endif %}
    </div>
    <div class="col-md-5">
      <div class="alert alert-warning alert-dismissible" role="alert">
        <button type="button" class="close" data-dismiss="alert" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
        - Editable and runable Jupyter/IPython cell on the left.<br>
        - Use <kbd>Run / Run Again</kbd> or <code>shift + return</code> to execute.<br>
        - MPFile I/O is handled automatically by <code>from/write_file()</code>.<br>
        - Resulting output MPFile is used for <kbd>View MPFile/Graphs</kbd>.<br>
        - Click <kbd>Load MPFile</kbd> to reload MPFile from ArchieML Sandbox.<br>
        - Click <kbd>Save Code</kbd> below to preserve your code changes.<br>
        - Start from scratch by clicking <kbd>Home</kbd>.
      </div>
      <button id="savecells" type="button" class="btn btn-info">Save Code</button>
    </div>
  </div>
</div>
<script>
  // save cell contents to hidden input field to preserve code changes
  $('#savecells').on('click', function (e) {
    var thebe_elem = document.getElementById('inputthebe');
    var thebe_nodes = document.getElementsByTagName('pre');
    var thebe_cells = [];
    for (var i=0; i<thebe_nodes.length; i++) {
      if (thebe_nodes[i].classList.contains("CodeMirror-line")) {
        var div = document.createElement("div");
        div.innerHTML = thebe_nodes[i].firstChild.innerHTML;
        var text = div.textContent || div.innerText || "";
        thebe_cells.push(text);
      }
    }
    thebe_elem.value = JSON.stringify(thebe_cells);
  })
</script>
{% endif %}
<div class="sandbox">
  <div class="container"><br>
    <div class="row">
      <div class="col-md-6"><strong>edit MPFile contents (ArchieML Sandbox):</strong></div>
      <div class="col-md-6"><strong>live-preview of JSON representation after default ArchieML parsing:</strong></div>
    </div>
{% if "mpfile" in session %}
<aml>{{session.mpfile|safe}}</aml>
{% else %}
<aml>This is an example MPFile in the ArchieML format.

Experiment.Preparation: Sputter deposition

{Experiment.Sample}
Material: Vicalloy
Authors: Contact Alpha T. N'Diaye (atndiaye@lbl.gov)

{Experiment.Measurement}
Detection: total electron yield
Temperature: RT
Orientation: 30° grazing incidence

{Experiment.Measurement.Beamline}
Beamline: ALS-6.3.1
Method: Soft x-ray XAS and XMCD
Monochromator.Exit_Slit: 20µm
Monochromator.Grating: 600l/mm

{Datasource}
directory: Vicalloy/rawdata
group_by: Z Y

{Fe_XMCD}
get_xmcd.energy_range: 690 740
scaling_preedge_to_1.preedge_range: 690 700
linear_background_removal_preedge_XAS.preedge_range: 690 700
xas_normalization_to_min_and_max.energy_range: 690 740
xas_xmcd_minmax:

[+AlNiCoCu.datatable]
Energy,XAS,XMCD
761,0.008445,-0.001452
762,0.007812,-0.000682

[+AlNiCoCu.table2]
Energy,XAS,XMCD
761,0.008445,-0.001452
762,0.007812,-0.000682

:ignore

[.processing]
* scaling background to 1
* constant background removal preedge
* normalization to L3

</aml>
{% endif %}
  </div>
</div>
<script type="text/javascript">
var qs = window.location.search.substring(1);
qs.split('&').forEach(function(term) {
  var temp = term.split('=');
  if (temp[0] == 'aml') {
    var source = decodeURIComponent(temp[1].replace(/\+/g, " "));
    var aml = document.getElementsByTagName('aml')[0];
    aml.innerHTML = source;
  }
});
</script>
<script src="{{ url_for('static', filename='js/sandbox.js') }}"></script>
{% endif %}
{% endblock %}
